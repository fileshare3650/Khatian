<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khatian Data Entry - Professional</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Choices.js CSS for searchable dropdowns -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .table-auto th, .table-auto td {
            padding: 12px 15px;
            text-align: left;
            white-space: nowrap;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .nav-btn {
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        .nav-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .nav-btn:not(.active) {
            background-color: #eef2ff; /* indigo-100 */
            color: #4f46e5; /* indigo-600 */
        }
        /* Style for table borders */
        .table-bordered th, .table-bordered td {
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Choices.js Customization */
        .choices__inner {
            background-color: white;
            border: 2px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            min-height: 42px; /* Set fixed height for alignment */
            height: 42px;
            padding-left: 1rem;
            display: flex;
            align-items: center;
        }
        .is-focused .choices__inner {
            border-color: #4f46e5 !important;
        }
        .choices[data-type*="select-one"]::after {
            right: 15.5px;
        }
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #4f46e5;
        }
        /* Hide placeholder from dropdown list */
        .choices__list--dropdown .choices__item[data-value=""] {
            display: none;
        }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="authContainer">
        <!-- Login View -->
        <div id="loginView" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome Back</h2>
                <p class="text-center text-gray-500 mb-8">Please login to your account</p>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">User ID</label>
                        <input type="text" id="username" value="admin" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="password" value="password" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline btn">Log In</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? 
                    <button id="showSignupBtn" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</button>
                </p>
            </div>
        </div>

        <!-- Signup View -->
        <div id="signupView" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">New User Sign Up</h2>
                <p class="text-center text-gray-500 mb-8">Create an account to get started</p>
                <form id="signupForm">
                    <div class="mb-4">
                        <label for="signupName" class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" id="signupName" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="signupUserId" class="block text-gray-700 text-sm font-bold mb-2">User ID</label>
                        <input type="text" id="signupUserId" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <p id="userIdError" class="text-red-500 text-xs italic mt-1 hidden">User ID must be at least 3 characters.</p>
                    </div>
                    <div class="mb-6">
                        <label for="signupPassword" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="signupPassword" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <p id="passwordError" class="text-red-500 text-xs italic mt-1 hidden">Password must be at least 4 digits.</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg btn">Sign Up</button>
                </form>
                 <button id="showLoginBtn" class="w-full mt-4 text-center text-indigo-600 hover:underline">Already have an account? Log In</button>
            </div>
        </div>
    </div>

    <!-- Main Application Section -->
    <div id="appSection" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Khatian Management System</h1>
                <div class="flex items-center gap-4">
                     <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                        <button id="homeBtn" class="nav-btn active"><i class="fas fa-home mr-2"></i>Home</button>
                        <button id="entryStatusBtn" class="nav-btn"><i class="fas fa-chart-bar mr-2"></i>Entry Status</button>
                     </div>
                     <div class="w-px h-8 bg-gray-300"></div>
                     <div class="flex items-center gap-3">
                        <span id="loggedInUser" class="font-semibold text-gray-700"></span>
                        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                     </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6">
            <!-- Home Page View -->
            <main id="homeView">
                <!-- Filter Section -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                     <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <button id="filterBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg btn"><i class="fas fa-filter mr-2"></i>Filter</button>
                     </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 items-end">
                        <div class="w-full">
                            <label for="districtFilter" class="block text-sm font-medium text-gray-700 mb-1">District</label>
                            <select id="districtFilter"></select>
                        </div>
                        <div class="w-full">
                            <label for="upazilaFilter" class="block text-sm font-medium text-gray-700 mb-1">Upazila</label>
                            <select id="upazilaFilter" disabled></select>
                        </div>
                        <div class="w-full">
                            <label for="mouzaFilter" class="block text-sm font-medium text-gray-700 mb-1">Mouza</label>
                            <select id="mouzaFilter" disabled></select>
                        </div>
                        <div class="w-full">
                            <label for="searchBox" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <input type="text" id="searchBox" placeholder="Insert Khatian or Dag" class="h-[42px] focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 border-2 rounded-md px-3">
                        </div>
                         <button id="clearFilterBtn" class="w-full xl:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md h-[42px] btn"><i class="fas fa-times mr-2"></i>Clear</button>
                    </div>
                </div>
    
                <!-- Action Buttons -->
                <div class="mb-8 flex flex-wrap gap-4">
                    <button id="newKhatianBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg btn"><i class="fas fa-plus mr-2"></i>New Khatian</button>
                    <button id="editKhatianBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg btn" disabled><i class="fas fa-edit mr-2"></i>Edit Khatian</button>
                    <button id="scanKhatianBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg btn" disabled><i class="fas fa-scanner mr-2"></i>Scan Khatian</button>
                    <button id="exportDataBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg btn"><i class="fas fa-file-excel mr-2"></i>Export Data</button>
                </div>
    
                <!-- Data Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                     <div id="tablePlaceholder" class="p-8 text-center text-gray-500">
                        <i class="fas fa-folder-open fa-3x mb-4 text-gray-400"></i>
                        <p>Please select District, Upazila, and Mouza, then click Filter.</p>
                    </div>
                    <table id="khatianTable" class="w-full table-auto hidden table-bordered">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="w-12">Select</th>
                                <th>Khatian No</th>
                                <th>RS No</th>
                                <th>Revenue</th>
                                <th>Mouza Name</th>
                                <th>Upazila Name</th>
                            </tr>
                        </thead>
                        <tbody id="khatianTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </main>
    
            <!-- Entry Status View -->
            <main id="entryStatusView" class="hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="font-bold text-xl text-gray-800 mb-4 border-b pb-3">User Entry Status (Last 30 Days)</h3>
                    <div class="overflow-x-auto">
                        <table id="entryStatusTable" class="w-full table-auto table-bordered">
                            <!-- Header and body will be generated by JS -->
                        </table>
                    </div>
                 </div>
            </main>
        </div>
    </div>

    <!-- New Khatian Modal -->
    <div id="newKhatianModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 modal-content transform scale-95 overflow-hidden">
             <div class="bg-indigo-600 text-white p-4 flex justify-between items-center">
                 <h3 class="text-lg font-semibold" id="modalTitle">Create New Khatian Entry</h3>
                <button id="closeModalBtn" class="text-indigo-200 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6" style="background-color: #F0F8FF;">
                <form id="khatianForm">
                    <div class="mb-4">
                        <label for="khatianNo" class="block text-sm font-medium text-gray-700 mb-1">Khatian No <span class="text-red-500">*</span></label>
                        <input type="text" id="khatianNo" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md py-2 px-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="rsNo" class="block text-sm font-medium text-gray-700 mb-1">RS No</label>
                        <input type="text" id="rsNo" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md py-2 px-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="revenue" class="block text-sm font-medium text-gray-700 mb-1">Revenue</label>
                        <input type="text" id="revenue" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md py-2 px-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                        <textarea id="remarks" rows="3" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md py-2 px-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500"></textarea>
                    </div>
                </form>
            </div>
            <div class="flex justify-end gap-4 p-4" style="background-color: #F0F8FF; border-top: 1px solid #e5e7eb;">
                <button type="button" id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button type="submit" form="khatianForm" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <i class="fas fa-check mr-2"></i>Create Khatian
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Alert -->
    <div id="customAlert" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm mx-4 text-center">
            <i class="fas fa-question-circle text-yellow-500 text-4xl mb-4"></i>
            <p id="alertMessage" class="text-lg text-gray-800 mb-6">Do you want to add new khatian?</p>
            <div class="flex justify-center gap-4">
                <button id="alertNoBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">No</button>
                <button id="alertYesBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
            </div>
        </div>
    </div>

    <!-- Choices.js script for searchable dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const authContainer = document.getElementById('authContainer');
            const appSection = document.getElementById('appSection');

            // Views
            const loginView = document.getElementById('loginView');
            const signupView = document.getElementById('signupView');
            const homeView = document.getElementById('homeView');
            const entryStatusView = document.getElementById('entryStatusView');
            
            // Forms
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const khatianForm = document.getElementById('khatianForm');

            // Buttons
            const showSignupBtn = document.getElementById('showSignupBtn');
            const showLoginBtn = document.getElementById('showLoginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const homeBtn = document.getElementById('homeBtn');
            const entryStatusBtn = document.getElementById('entryStatusBtn');
            const newKhatianBtn = document.getElementById('newKhatianBtn');
            const editKhatianBtn = document.getElementById('editKhatianBtn');
            const scanKhatianBtn = document.getElementById('scanKhatianBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const filterBtn = document.getElementById('filterBtn');
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const alertYesBtn = document.getElementById('alertYesBtn');
            const alertNoBtn = document.getElementById('alertNoBtn');
            
            // Other Elements
            const khatianTable = document.getElementById('khatianTable');
            const khatianTableBody = document.getElementById('khatianTableBody');
            const entryStatusTable = document.getElementById('entryStatusTable');
            const tablePlaceholder = document.getElementById('tablePlaceholder');
            const newKhatianModal = document.getElementById('newKhatianModal');
            const customAlert = document.getElementById('customAlert');
            const districtFilterEl = document.getElementById('districtFilter');
            const upazilaFilterEl = document.getElementById('upazilaFilter');
            const mouzaFilterEl = document.getElementById('mouzaFilter');
            const searchBox = document.getElementById('searchBox');
            const loggedInUserSpan = document.getElementById('loggedInUser');

            // --- State and Mock Data ---
             const geoData = {
                "Bagerhat": { "Bagerhat Sadar": [], "Chitalmari": [], "Fakirhat": [], "Kachua": [], "Mollahat": [], "Mongla": [], "Morrelganj": [], "Rampal": [], "Sarankhola": [] },
                "Bandarban": { "Bandarban Sadar": [], "Thanchi": [], "Rowangchhari": [], "Lama": [], "Ruma": [], "Alikadam": [], "Naikhongchhari": [] },
                "Barguna": { "Amtali": [], "Barguna Sadar": [], "Betagi": [], "Patharghata": [], "Taltali": [] },
                "Barishal": { "Agailjhara": [], "Bakerganj": [], "Barishal Sadar": [], "Banaripara": [], "Gournadi": [], "Hizla": [], "Mehendiganj": [], "Muladi": [], "Wazirpur": [] },
                "Bhola": { "Bhola Sadar": [], "Burhanuddin": [], "Char Fasson": [], "Daulatkhan": [], "Lalmohan": [], "Manpura": [], "Tazumuddin": [] },
                "Bogra": { "Adamdighi": [], "Bogra Sadar": [], "Dhunat": [], "Dhupchanchia": [], "Gabtali": [], "Kahaloo": [], "Nandigram": [], "Sariakandi": [], "Shajahanpur": [], "Sherpur": [], "Shibganj": [], "Sonatala": [] },
                "Brahmanbaria": { "Akhaura": [], "Ashuganj": [], "Bancharampur": [], "Bijoynagar": [], "Brahmanbaria Sadar": [], "Kasba": [], "Nabinagar": [], "Nasirnagar": [], "Sarail": [] },
                "Chandpur": { "Chandpur Sadar": [], "Faridganj": [], "Haimchar": [], "Hajiganj": [], "Kachua": [], "Matlab Dakshin": [], "Matlab Uttar": [], "Shahrasti": [] },
                "Chapai Nawabganj": { "Bholahat": [], "Gomastapur": [], "Nachole": [], "Chapai Nawabganj Sadar": [], "Shibganj": [] },
                "Chattogram": { "Anwara": [], "Banshkhali": [], "Boalkhali": [], "Chandanaish": [], "Fatikchhari": [], "Hathazari": [], "Karnaphuli": [], "Lohagara": [], "Mirsharai": [], "Patiya": [], "Rangunia": [], "Raozan": [], "Sandwip": [], "Satkania": [], "Sitakunda": [] },
                "Chuadanga": { "Alamdanga": [], "Chuadanga Sadar": [], "Damurhuda": [], "Jibannagar": [] },
                "Cumilla": { "Barura": [], "Brahmanpara": [], "Burichang": [], "Chandina": [], "Chauddagram": [], "Cumilla Sadar": [], "Daudkandi": [], "Debidwar": [], "Homna": [], "Laksam": [], "Lalmai": [], "Meghna": [], "Monohorgonj": [], "Muradnagar": [], "Nangalkot": [], "Titas": [] },
                "Cox's Bazar": { "Chakaria": [], "Cox's Bazar Sadar": [], "Kutubdia": [], "Maheshkhali": [], "Pekua": [], "Ramu": [], "Teknaf": [], "Ukhia": [] },
                "Dhaka": { "Dhamrai": ["Amta", "Kulla"], "Dohar": [], "Keraniganj": [], "Nawabganj": [], "Savar": ["Aminbazar", "Tetuljhora"] },
                "Dinajpur": { "Biral": [], "Birampur": [], "Birganj": [], "Bochaganj": [], "Chirirbandar": [], "Dinajpur Sadar": [], "Phulbari": [], "Ghoraghat": [], "Hakimpur": [], "Kaharole": [], "Khansama": [], "Nawabganj": [], "Parbatipur": [] },
                "Faridpur": { "Alfadanga": [], "Bhanga": [], "Boalmari": [], "Charbhadrasan": [], "Faridpur Sadar": [], "Madhukhali": [], "Nagarkanda": [], "Sadarpur": [] },
                "Feni": { "Chhagalnaiya": [], "Daganbhuiyan": [], "Feni Sadar": [], "Fulgazi": [], "Parshuram": [], "Sonagazi": [] },
                "Gaibandha": { "Phulchhari": [], "Gaibandha Sadar": [], "Gobindaganj": [], "Palashbari": [], "Sadullapur": [], "Sughatta": [], "Sundarganj": [] },
                "Gazipur": { "Gazipur Sadar": [], "Kaliakair": [], "Kaliganj": [], "Kapasia": [], "Sreepur": [] },
                "Gopalganj": { "Gopalganj Sadar": [], "Kashiani": [], "Kotalipara": [], "Muksudpur": [], "Tungipara": [] },
                "Habiganj": { "Ajmiriganj": [], "Bahubal": [], "Baniachong": [], "Chunarughat": [], "Habiganj Sadar": [], "Lakhai": [], "Madhabpur": [], "Nabiganj": [] },
                "Jamalpur": { "Baksiganj": [], "Dewanganj": [], "Islampur": [], "Jamalpur Sadar": [], "Madarganj": [], "Melandaha": [], "Sarishabari": [] },
                "Jashore": { "Abhaynagar": [], "Bagherpara": [], "Chaugachha": [], "Jashore Sadar": [], "Jhikargachha": [], "Keshabpur": [], "Manirampur": [], "Sharsha": [] },
                "Jhalokati": { "Jhalokati Sadar": [], "Kathalia": [], "Nalchity": [], "Rajapur": [] },
                "Jhenaidah": { "Harinakundu": [], "Jhenaidah Sadar": [], "Kaliganj": [], "Kotchandpur": [], "Maheshpur": [], "Shailkupa": [] },
                "Joypurhat": { "Akkelpur": [], "Joypurhat Sadar": [], "Kalai": [], "Khetlal": [], "Panchbibi": [] },
                "Khagrachhari": { "Dighinala": [], "Khagrachhari Sadar": [], "Lakshmichhari": [], "Mahalchhari": [], "Manikchhari": [], "Matiranga": [], "Panchhari": [], "Ramgarh": [] },
                "Khulna": { "Batiaghata": [], "Dacope": [], "Dighalia": [], "Dumuria": [], "Khulna Sadar": [], "Koyra": [], "Paikgachha": [], "Phultala": [], "Rupsha": [], "Terokhada": [] },
                "Kishoreganj": { "Austagram": [], "Bajitpur": [], "Bhairab": [], "Hossainpur": [], "Itna": [], "Karimganj": [], "Katiadi": [], "Kishoreganj Sadar": [], "Kuliarchar": [], "Mithamain": [], "Nikli": [], "Pakundia": [], "Tarail": [] },
                "Kurigram": { "Bhurungamari": [], "Char Rajibpur": [], "Chilmari": [], "Kurigram Sadar": [], "Nageshwari": [], "Phulbari": [], "Rajarhat": [], "Rowmari": [], "Ulipur": [] },
                "Kushtia": { "Bheramara": [], "Daulatpur": [], "Khoksa": [], "Kumarkhali": [], "Kushtia Sadar": [], "Mirpur": [] },
                "Lakshmipur": { "Kamalnagar": [], "Lakshmipur Sadar": [], "Raipur": [], "Ramganj": [], "Ramgati": [] },
                "Lalmonirhat": { "Aditmari": [], "Hatibandha": [], "Kaliganj": [], "Lalmonirhat Sadar": [], "Patgram": [] },
                "Madaripur": { "Dasar": [], "Kalkini": [], "Madaripur Sadar": [], "Rajoir": [], "Shibchar": [] },
                "Magura": { "Magura Sadar": [], "Mohammadpur": [], "Shalikha": [], "Sreepur": [] },
                "Manikganj": { "Daulatpur": [], "Ghior": [], "Harirampur": [], "Manikganj Sadar": [], "Saturia": [], "Shivalaya": [], "Singair": [] },
                "Moulvibazar": { "Barlekha": [], "Juri": [], "Kamalganj": [], "Kulaura": [], "Moulvibazar Sadar": [], "Rajnagar": [], "Sreemangal": [] },
                "Munshiganj": { "Gazaria": [], "Lohajang": [], "Munshiganj Sadar": [], "Sirajdikhan": [], "Sreenagar": [], "Tongibari": [] },
                "Mymensingh": { "Bhaluka": [], "Dhobaura": [], "Fulbaria": [], "Gaffargaon": [], "Gouripur": [], "Haluaghat": [], "Ishwarganj": [], "Muktagachha": [], "Mymensingh Sadar": [], "Nandail": [], "Phulpur": [], "Tarakanda": [], "Trishal": [] },
                "Naogaon": { "Atrai": [], "Badalgachhi": [], "Dhamoirhat": [], "Manda": [], "Mohadevpur": [], "Naogaon Sadar": [], "Niamatpur": [], "Patnitala": [], "Porsha": [], "Raninagar": [], "Sapahar": [] },
                "Narail": { "Kalia": [], "Lohagara": [], "Narail Sadar": [] },
                "Narayanganj": { "Araihazar": [], "Bandar": [], "Narayanganj Sadar": [], "Rupganj": [], "Sonargaon": [] },
                "Narsingdi": { "Belabo": [], "Monohardi": [], "Narsingdi Sadar": [], "Palash": [], "Raipura": [], "Shibpur": [] },
                "Natore": { "Bagatipara": [], "Baraigram": [], "Gurudaspur": [], "Lalpur": [], "Naldanga": [], "Natore Sadar": [], "Singra": [] },
                "Netrokona": { "Atpara": [], "Barhatta": [], "Durgapur": [], "Kalmakanda": [], "Kendua": [], "Khaliajuri": [], "Madan": [], "Mohanganj": [], "Netrokona Sadar": [], "Purbadhala": [] },
                "Nilphamari": { "Dimla": [], "Domar": [], "Jaldhaka": [], "Kishoreganj": [], "Nilphamari Sadar": [], "Syedpur": [] },
                "Noakhali": { "Begumganj": [], "Chatkhil": [], "Companyganj": [], "Hatiya": [], "Kabirhat": [], "Noakhali Sadar": [], "Senbagh": [], "Sonaimuri": [], "Subarnachar": [] },
                "Pabna": { "Atgharia": [], "Bera": [], "Bhangura": [], "Chatmohar": [], "Faridpur": [], "Ishwardi": [], "Pabna Sadar": [], "Santhia": [], "Sujanagar": [] },
                "Panchagarh": { "Atwari": [], "Boda": [], "Debiganj": [], "Panchagarh Sadar": [], "Tetulia": [] },
                "Patuakhali": { "Bauphal": [], "Dashmina": [], "Dumki": [], "Galachipa": [], "Kalapara": [], "Mirzaganj": [], "Patuakhali Sadar": [], "Rangabali": [] },
                "Pirojpur": { "Bhandaria": [], "Indurkani": [], "Kawkhali": [], "Mathbaria": [], "Nazirpur": [], "Nesarabad": [], "Pirojpur Sadar": [] },
                "Rajbari": { "Baliakandi": [], "Goalandaghat": [], "Kalukhali": [], "Pangsha": [], "Rajbari Sadar": [] },
                "Rajshahi": { "Bagha": [], "Bagmara": [], "Charghat": [], "Durgapur": [], "Godagari": [], "Mohanpur": [], "Paba": [], "Puthia": [], "Tanore": [] },
                "Rangamati": { "Bagaichhari": [], "Barkal": [], "Belaichhari": [], "Juraichhari": [], "Kaptai": [], "Langadu": [], "Naniarchar": [], "Rajasthali": [], "Rangamati Sadar": [] },
                "Rangpur": { "Badarganj": [], "Gangachhara": [], "Kaunia": [], "Mithapukur": [], "Pirgachha": [], "Pirganj": [], "Rangpur Sadar": [], "Taraganj": [] },
                "Satkhira": { "Assasuni": [], "Debhata": [], "Kalaroa": [], "Kaliganj": [], "Satkhira Sadar": [], "Shyamnagar": [], "Tala": [] },
                "Shariatpur": { "Bhedarganj": [], "Damudya": [], "Gosairhat": [], "Naria": [], "Shariatpur Sadar": [], "Zajira": [] },
                "Sherpur": { "Jhenaigati": [], "Nakla": [], "Nalitabari": [], "Sherpur Sadar": [], "Sreebardi": [] },
                "Sirajganj": { "Belkuchi": [], "Chauhali": [], "Kamarkhanda": [], "Kazipur": [], "Raiganj": [], "Shahjadpur": [], "Sirajganj Sadar": [], "Tarash": [], "Ullahpara": [] },
                "Sunamganj": { "Bishwambarpur": [], "Chhatak": [], "Derai": [], "Dharampasha": [], "Dowarabazar": [], "Jagannathpur": [], "Jamalganj": [], "Sullah": [], "Sunamganj Sadar": [], "Tahirpur": [] },
                "Sylhet": { "Balaganj": [], "Beanibazar": [], "Bishwanath": [], "Companiganj": [], "Dakshin Surma": [], "Fenchuganj": [], "Golapganj": [], "Gowainghat": [], "Jaintiapur": [], "Kanaighat": [], "Sylhet Sadar": [], "Zakiganj": [] },
                "Tangail": { "Basail": [], "Bhuapur": [], "Delduar": [], "Dhanbari": [], "Ghatail": [], "Gopalpur": [], "Kalihati": [], "Madhupur": [], "Mirzapur": [], "Nagarpur": [], "Sakhipur": [], "Tangail Sadar": [] },
                "Thakurgaon": { "Baliadangi": [], "Haripur": [], "Pirganj": [], "Ranisankail": [], "Thakurgaon Sadar": [] }
            };

            let users = [
                { id: 1, name: 'Admin User', userId: 'admin', password: 'password' }
            ];

            let khatianData = [
                { id: 1, khatianNo: '101', rsNo: 'RS-501', revenue: '5000', remarks: 'N/A', district: 'Dhaka', upazila: 'Savar', mouza: 'Aminbazar', enteredBy: 'admin', entryDate: '2025-06-14' },
                { id: 2, khatianNo: '102', rsNo: 'RS-502', revenue: '6000', remarks: 'Paid', district: 'Dhaka', upazila: 'Savar', mouza: 'Aminbazar', enteredBy: 'admin', entryDate: '2025-06-15' }
            ];
            
            let currentUser = null;
            let selectedKhatianId = null;

            // Initialize Choices.js dropdowns
            const choiceOptions = {
                searchEnabled: true, 
                shouldSort: false,
                searchChoices: true, 
                itemSelectText: '', 
            };

            const districtChoice = new Choices(districtFilterEl, {...choiceOptions, placeholder: true, placeholderValue: 'Select District' });
            const upazilaChoice = new Choices(upazilaFilterEl, {...choiceOptions, placeholder: true, placeholderValue: 'Select Upazila' });
            const mouzaChoice = new Choices(mouzaFilterEl, {...choiceOptions, placeholder: true, placeholderValue: 'Select Mouza' });

            // --- Functions ---
            const showView = (viewId) => {
                [loginView, signupView].forEach(v => v.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
            };

            const showPage = (pageId) => {
                [homeView, entryStatusView].forEach(p => p.classList.add('hidden'));
                [homeBtn, entryStatusBtn].forEach(b => b.classList.remove('active'));
                
                document.getElementById(pageId).classList.remove('hidden');
                if (pageId === 'homeView') homeBtn.classList.add('active');
                if (pageId === 'entryStatusView') entryStatusBtn.classList.add('active');
            };
            
            const setChoices = (choiceInstance, data, placeholder) => {
                choiceInstance.clearStore();
                choiceInstance.setChoices(
                    [{ value: '', label: placeholder, selected: true, disabled: true }, ...data.map(item => ({ value: item, label: item }))],
                    'value', 'label', false
                );
            };
            
            const renderKhatianTable = () => {
                const district = districtChoice.getValue(true);
                const upazila = upazilaChoice.getValue(true);
                const mouza = mouzaChoice.getValue(true);
                const searchTerm = searchBox.value.toLowerCase();

                if (!district || !upazila || !mouza) {
                    khatianTable.classList.add('hidden');
                    tablePlaceholder.classList.remove('hidden');
                    khatianTableBody.innerHTML = '';
                    return;
                }

                khatianTable.classList.remove('hidden');
                tablePlaceholder.classList.add('hidden');

                let filteredData = khatianData.filter(k => 
                    k.district === district && k.upazila === upazila && k.mouza === mouza &&
                    (k.khatianNo.toLowerCase().includes(searchTerm) || (k.rsNo && k.rsNo.toLowerCase().includes(searchTerm)))
                );

                khatianTableBody.innerHTML = '';
                if (filteredData.length === 0) {
                    khatianTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">No Khatian found.</td></tr>`;
                } else {
                    filteredData.forEach(k => {
                        khatianTableBody.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td><input type="radio" name="khatianSelect" value="${k.id}" class="form-radio h-4 w-4 text-indigo-600"></td>
                                <td>${k.khatianNo}</td><td>${k.rsNo || '-'}</td><td>${k.revenue || '-'}</td>
                                <td>${k.mouza}</td><td>${k.upazila}</td>
                            </tr>`;
                    });
                }
                attachRadioListeners();
                selectedKhatianId = null;
                editKhatianBtn.disabled = true;
                scanKhatianBtn.disabled = true;
            };
            
            const attachRadioListeners = () => {
                 document.querySelectorAll('input[name="khatianSelect"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        selectedKhatianId = parseInt(e.target.value);
                        editKhatianBtn.disabled = false;
                        scanKhatianBtn.disabled = false;
                    });
                });
            }

            const renderEntryStatusTable = () => {
                const allUserIds = [...new Set(users.map(u => u.userId))].sort();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentEntries = khatianData.filter(k => new Date(k.entryDate) >= thirtyDaysAgo);

                const entriesByDate = recentEntries.reduce((acc, entry) => {
                    const date = entry.entryDate;
                    if (!acc[date]) acc[date] = {};
                    acc[date][entry.enteredBy] = (acc[date][entry.enteredBy] || 0) + 1;
                    return acc;
                }, {});

                const uniqueDates = Object.keys(entriesByDate).sort((a, b) => new Date(b) - new Date(a));

                let tableHtml = `<thead class="bg-gray-100"><tr><th>Date</th>`;
                allUserIds.forEach(userId => {
                    tableHtml += `<th>${userId}</th>`;
                });
                tableHtml += `</tr></thead><tbody class="divide-y">`;

                if (uniqueDates.length === 0) {
                    tableHtml += `<tr><td colspan="${allUserIds.length + 1}" class="text-center text-gray-500 py-4">No entries in the last 30 days.</td></tr>`;
                } else {
                    uniqueDates.forEach(date => {
                        tableHtml += `<tr class="hover:bg-gray-50"><td>${new Date(date).toLocaleDateString('en-GB')}</td>`;
                        allUserIds.forEach(userId => {
                            const count = entriesByDate[date][userId] || 0;
                            tableHtml += `<td class="text-center">${count > 0 ? count : '-'}</td>`;
                        });
                        tableHtml += `</tr>`;
                    });
                }

                tableHtml += `</tbody>`;
                entryStatusTable.innerHTML = tableHtml;
            };
            
            const openModal = () => {
                khatianForm.reset();
                newKhatianModal.classList.remove('hidden');
                newKhatianModal.classList.add('flex');
                setTimeout(() => newKhatianModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
            };

            const closeModal = () => {
                newKhatianModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => newKhatianModal.classList.add('hidden'), 300);
            };
            
            const showAlert = () => {
                customAlert.classList.remove('hidden');
                customAlert.classList.add('flex');
            };

            const hideAlert = () => {
                customAlert.classList.add('hidden');
            };
            
            const clearFilters = () => {
                setChoices(districtChoice, Object.keys(geoData), 'Select District');
                upazilaChoice.clearStore();
                upazilaChoice.disable();
                mouzaChoice.clearStore();
                mouzaChoice.disable();
                searchBox.value = '';
                renderKhatianTable();
            };
            
            const handleLogout = () => {
                currentUser = null;
                appSection.classList.add('hidden');
                authContainer.classList.remove('hidden');
                showView('loginView');
            }

            // --- Initial Setup ---
            setChoices(districtChoice, Object.keys(geoData), 'Select District');
            
            // --- Event Listeners ---
            showSignupBtn.addEventListener('click', () => showView('signupView'));
            showLoginBtn.addEventListener('click', () => showView('loginView'));
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userId = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const user = users.find(u => u.userId === userId && u.password === password);
                if (user) {
                    currentUser = user;
                    loggedInUserSpan.textContent = `Hi, ${currentUser.name}`;
                    authContainer.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    showPage('homeView');
                    renderKhatianTable();
                } else {
                    alert('Invalid credentials.');
                }
            });

            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const userId = document.getElementById('signupUserId').value;
                const password = document.getElementById('signupPassword').value;

                const userIdError = document.getElementById('userIdError');
                const passwordError = document.getElementById('passwordError');
                let isValid = true;
                userIdError.classList.add('hidden');
                passwordError.classList.add('hidden');

                if(userId.length < 3) {
                    userIdError.classList.remove('hidden'); isValid = false;
                } 
                if(password.length < 4) {
                    passwordError.classList.remove('hidden'); isValid = false;
                }
                if(users.some(u => u.userId === userId)) {
                    alert('User ID already exists. Please choose another one.'); isValid = false;
                }
                if (!isValid) return;

                users.push({ id: users.length + 1, name, userId, password });
                alert('Account created successfully! Please log in.');
                showView('loginView');
                signupForm.reset();
            });

            logoutBtn.addEventListener('click', handleLogout);
            homeBtn.addEventListener('click', () => showPage('homeView'));
            entryStatusBtn.addEventListener('click', () => {
                renderEntryStatusTable();
                showPage('entryStatusView');
            });
            
            districtFilterEl.addEventListener('change', (event) => {
                const district = event.detail.value;
                upazilaChoice.clearInput();
                upazilaChoice.clearStore();
                mouzaChoice.clearInput();
                mouzaChoice.clearStore();
                mouzaChoice.disable();
                if (district) {
                    upazilaChoice.enable();
                    setChoices(upazilaChoice, Object.keys(geoData[district] || {}), 'Select Upazila');
                } else {
                    upazilaChoice.disable();
                }
            });

            upazilaFilterEl.addEventListener('change', (event) => {
                const district = districtChoice.getValue(true);
                const upazila = event.detail.value;
                mouzaChoice.clearInput();
                mouzaChoice.clearStore();
                if (upazila && geoData[district]?.[upazila]) {
                    mouzaChoice.enable();
                    setChoices(mouzaChoice, geoData[district][upazila].length > 0 ? geoData[district][upazila] : ['Mouza X', 'Mouza Y'], 'Select Mouza');
                } else {
                    mouzaChoice.disable();
                }
            });

            filterBtn.addEventListener('click', renderKhatianTable);
            clearFilterBtn.addEventListener('click', clearFilters);

            newKhatianBtn.addEventListener('click', () => {
                 if (!districtChoice.getValue(true) || !upazilaChoice.getValue(true) || !mouzaChoice.getValue(true)) {
                    alert('Please select District, Upazila, and Mouza first.');
                    return;
                }
                showAlert();
            });
            
            alertYesBtn.addEventListener('click', () => { hideAlert(); openModal(); });
            alertNoBtn.addEventListener('click', hideAlert);
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            khatianForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const today = new Date().toISOString().slice(0, 10);
                const newKhatian = {
                    id: khatianData.length > 0 ? Math.max(...khatianData.map(k => k.id)) + 1 : 1,
                    khatianNo: document.getElementById('khatianNo').value,
                    rsNo: document.getElementById('rsNo').value,
                    revenue: document.getElementById('revenue').value,
                    remarks: document.getElementById('remarks').value,
                    district: districtChoice.getValue(true),
                    upazila: upazilaChoice.getValue(true),
                    mouza: mouzaChoice.getValue(true),
                    enteredBy: currentUser.userId,
                    entryDate: today
                };
                khatianData.push(newKhatian);
                closeModal();
                renderKhatianTable();
            });

            editKhatianBtn.addEventListener('click', () => {
                if(selectedKhatianId) {
                    alert(`Functionality to edit Khatian ID: ${selectedKhatianId} would be here.`);
                }
            });

            scanKhatianBtn.addEventListener('click', () => {
                if(selectedKhatianId) {
                     alert(`Functionality to upload scan for Khatian ID: ${selectedKhatianId} would be here.`);
                }
            });

            exportDataBtn.addEventListener('click', () => {
                const district = districtChoice.getValue(true);
                const upazila = upazilaChoice.getValue(true);
                const mouza = mouzaChoice.getValue(true);

                if (!district || !upazila || !mouza) {
                    alert('Please select criteria to export data.');
                    return;
                }
                const dataToExport = khatianData
                    .filter(k => k.district === district && k.upazila === upazila && k.mouza === mouza)
                    .map(k => ({ 'Khatian No': k.khatianNo, 'RS No': k.rsNo, 'Revenue': k.revenue, 'Mouza': k.mouza, 'Upazila': k.upazila, 'Entered By': k.enteredBy, 'Date': k.entryDate }));

                if(dataToExport.length === 0) {
                    alert('No data to export.'); return;
                }
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Khatian Data");
                XLSX.writeFile(workbook, `Khatian_Data_${district}_${upazila}_${mouza}.xlsx`);
            });
        });
    </script>
</body>
</html>
